<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Max Messenger</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root {
  --bg:        #0b0d13;
  --surf:      #12151e;
  --surf2:     #1a1f2e;
  --surf3:     #222840;
  --border:    rgba(255,255,255,.07);
  --text:      #e9edf8;
  --muted:     #57607e;
  --accent:    #4f7ef8;
  --accent2:   #8b5cf6;
  --green:     #34d399;
  --red:       #f87171;
  --msg-in:    #19213a;
  --msg-out-a: #2d4fd6;
  --msg-out-b: #5b21b6;
  --r:         14px;
  --font:      'Nunito', sans-serif;
  --sab:       env(safe-area-inset-bottom, 0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--font);font-size:15px;overflow:hidden}

/* â”€â”€ SCREEN SYSTEM â”€â”€ */
.scr{position:fixed;inset:0;display:flex;flex-direction:column;transition:opacity .22s, transform .22s}
.scr.off{opacity:0;pointer-events:none;transform:translateX(30px)}
.scr.slide-left.off{transform:translateX(-30px)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scr-auth{
  align-items:center;justify-content:center;gap:0;
  padding:40px 28px;
  background:radial-gradient(ellipse 70% 50% at 50% 0%,#1e2a5e30,transparent),var(--bg);
}
.auth-icon{
  width:96px;height:96px;border-radius:30px;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  display:flex;align-items:center;justify-content:center;font-size:46px;
  box-shadow:0 0 60px rgba(79,126,248,.3),0 0 120px rgba(79,126,248,.12);
  margin-bottom:26px;
  animation:iconFloat 3.5s ease-in-out infinite;
}
@keyframes iconFloat{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-9px) rotate(2deg)}}
.auth-h{font-size:28px;font-weight:900;margin-bottom:6px;letter-spacing:-.5px}
.auth-sub{font-size:14px;color:var(--muted);margin-bottom:36px;text-align:center;line-height:1.5}

.field-wrap{width:100%;position:relative;margin-bottom:12px}
.field-wrap svg{position:absolute;left:15px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none}
.field{
  width:100%;background:var(--surf2);border:1.5px solid var(--border);
  border-radius:var(--r);padding:14px 16px 14px 44px;
  color:var(--text);font-family:var(--font);font-size:16px;outline:none;
  transition:border-color .2s,box-shadow .2s;letter-spacing:1px;
}
.field:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(79,126,248,.15)}
.field::placeholder{color:var(--muted);letter-spacing:0}

.btn{
  width:100%;padding:15px;border-radius:var(--r);
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border:none;color:#fff;font-family:var(--font);font-size:16px;font-weight:800;
  cursor:pointer;letter-spacing:.3px;
  box-shadow:0 8px 32px rgba(79,126,248,.38);
  transition:transform .15s,box-shadow .15s,opacity .15s;
  position:relative;overflow:hidden;
}
.btn::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,.1);opacity:0;transition:opacity .15s}
.btn:active{transform:scale(.97);box-shadow:0 4px 16px rgba(79,126,248,.3)}
.btn:active::after{opacity:1}
.btn:disabled{opacity:.5;pointer-events:none}

.auth-err{min-height:18px;font-size:13px;color:var(--red);margin-top:10px;text-align:center}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NEEDS LOGIN (QR screen)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scr-login{align-items:center;justify-content:center;gap:16px;padding:32px}
.login-icon{font-size:60px}
.login-h{font-size:22px;font-weight:800;text-align:center}
.login-sub{font-size:14px;color:var(--muted);text-align:center;line-height:1.6}
.qr-img{width:240px;height:240px;border-radius:16px;object-fit:contain;border:2px solid var(--border);background:white;padding:8px}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scr-chats{background:var(--bg)}

.topbar{
  display:flex;align-items:center;gap:10px;
  padding:12px 16px 10px;
  background:var(--surf);border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.topbar-title{flex:1;font-size:21px;font-weight:900;letter-spacing:-.3px}
.topbar-title b{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
}
.topbar-user{font-size:13px;color:var(--muted)}

.ico-btn{
  width:37px;height:37px;border-radius:11px;
  background:var(--surf2);border:1px solid var(--border);
  color:var(--muted);display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:background .15s,color .15s;flex-shrink:0;
}
.ico-btn:active{background:var(--accent);color:#fff;border-color:var(--accent)}

.srch-wrap{padding:8px 14px;position:relative;flex-shrink:0}
.srch-wrap svg{position:absolute;left:26px;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none}
.srch{
  width:100%;background:var(--surf2);border:1px solid var(--border);
  border-radius:22px;padding:9px 14px 9px 38px;
  color:var(--text);font-family:var(--font);font-size:14px;outline:none;
  transition:border-color .2s;
}
.srch:focus{border-color:var(--accent)}

#list{flex:1;overflow-y:auto;overscroll-behavior:contain}
#list::-webkit-scrollbar{width:3px}
#list::-webkit-scrollbar-thumb{background:var(--surf3);border-radius:2px}

.ci{
  display:flex;align-items:center;gap:12px;
  padding:10px 16px;cursor:pointer;
  border-bottom:1px solid var(--border);
  transition:background .1s;position:relative;
  -webkit-user-select:none;user-select:none;
}
.ci:active,.ci.act{background:var(--surf2)}
.ci.act::before{
  content:'';position:absolute;left:0;top:10px;bottom:10px;
  width:3px;border-radius:0 3px 3px 0;
  background:linear-gradient(var(--accent),var(--accent2));
}
.av{
  width:50px;height:50px;border-radius:50%;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:900;color:#fff;overflow:hidden;position:relative;
}
.av img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.ci-body{flex:1;min-width:0}
.ci-name{font-weight:700;font-size:14.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ci-prev{font-size:13px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px}
.ci-meta{display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0}
.ci-time{font-size:11.5px;color:var(--muted)}
.badge{background:var(--accent);color:#fff;border-radius:10px;font-size:11px;font-weight:700;padding:1px 6px;min-width:18px;text-align:center}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#scr-chat{background:var(--bg)}

.chat-hdr{
  display:flex;align-items:center;gap:10px;
  padding:10px 14px;
  background:var(--surf);border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.back-btn{
  width:36px;height:36px;border-radius:11px;
  background:var(--surf2);border:none;color:var(--text);
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:background .15s;flex-shrink:0;
}
.back-btn:active{background:var(--accent)}
.chat-hdr-txt{flex:1;min-width:0}
.chat-hdr-name{font-weight:800;font-size:16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chat-hdr-sub{font-size:12px;color:var(--muted);margin-top:1px}

#msgs{
  flex:1;overflow-y:auto;padding:12px 14px;
  display:flex;flex-direction:column;gap:3px;
  overscroll-behavior:contain;
}
#msgs::-webkit-scrollbar{width:3px}
#msgs::-webkit-scrollbar-thumb{background:var(--surf3);border-radius:2px}

.bbl{
  max-width:80%;padding:9px 13px;border-radius:18px;
  font-size:14.5px;line-height:1.5;word-break:break-word;
  animation:bblIn .18s cubic-bezier(.34,1.4,.64,1);
}
@keyframes bblIn{from{opacity:0;transform:scale(.93) translateY(5px)}to{opacity:1;transform:none}}
.b-in{background:var(--msg-in);align-self:flex-start;border-bottom-left-radius:5px}
.b-out{
  background:linear-gradient(135deg,var(--msg-out-a),var(--msg-out-b));
  align-self:flex-end;border-bottom-right-radius:5px;color:#fff;
}
.bbl-time{font-size:10.5px;color:rgba(255,255,255,.4);margin-top:3px;text-align:right}
.b-in .bbl-time{color:var(--muted);text-align:left}

.day-div{
  align-self:center;font-size:12px;color:var(--muted);
  background:var(--surf2);border:1px solid var(--border);
  padding:3px 13px;border-radius:20px;margin:8px 0;
}
.msgs-empty{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:10px;
  color:var(--muted);font-size:14px;
}

/* â”€â”€ COMPOSER â”€â”€ */
#composer{
  display:flex;align-items:flex-end;gap:8px;
  padding:9px 12px calc(9px + var(--sab));
  background:var(--surf);border-top:1px solid var(--border);
  flex-shrink:0;
}
#inp{
  flex:1;background:var(--surf2);border:1.5px solid var(--border);
  border-radius:22px;padding:11px 16px;
  color:var(--text);font-family:var(--font);font-size:15px;
  outline:none;resize:none;min-height:46px;max-height:134px;
  line-height:1.45;overflow-y:auto;
  transition:border-color .2s;
}
#inp:focus{border-color:var(--accent)}
#inp:empty::before{content:attr(data-ph);color:var(--muted)}
#send-btn{
  width:46px;height:46px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  border:none;color:#fff;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;
  box-shadow:0 4px 18px rgba(79,126,248,.4);
  transition:transform .15s,opacity .15s;
}
#send-btn:active{transform:scale(.88)}
#send-btn:disabled{opacity:.35;pointer-events:none}

/* â”€â”€ LOADER â”€â”€ */
#loader{
  position:fixed;inset:0;z-index:999;
  background:rgba(11,13,19,.82);backdrop-filter:blur(10px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;
}
#loader.off{display:none}
.spin{width:34px;height:34px;border:3px solid var(--surf3);border-top-color:var(--accent);border-radius:50%;animation:sp .75s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
#loader-txt{font-size:14px;color:var(--muted)}

/* â”€â”€ TOAST â”€â”€ */
#toast{
  position:fixed;bottom:88px;left:50%;transform:translateX(-50%);
  background:var(--surf3);border:1px solid var(--border);
  border-radius:12px;padding:9px 18px;font-size:13px;
  opacity:0;transition:opacity .25s;pointer-events:none;z-index:998;white-space:nowrap;
}
#toast.on{opacity:1}
</style>
</head>
<body>

<div id="loader"><div class="spin"></div><div id="loader-txt">Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...</div></div>
<div id="toast"></div>

<!-- â•â• AUTH â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="scr-auth" class="scr off">
  <div class="auth-icon">ğŸ’¬</div>
  <div class="auth-h">Max Messenger</div>
  <div class="auth-sub">Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ»ÑÑ‡ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°<br>Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ° Ğ² Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚</div>

  <div class="field-wrap" style="width:100%;max-width:340px">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
      <rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
    </svg>
    <input id="auth-f" class="field" type="password" placeholder="ĞšĞ»ÑÑ‡ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°" maxlength="80" autocomplete="off">
  </div>
  <div style="width:100%;max-width:340px">
    <button class="btn" id="auth-btn" onclick="doAuth()">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ â†’</button>
  </div>
  <div id="auth-err" class="auth-err"></div>
</div>

<!-- â•â• NEEDS LOGIN (QR) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="scr-login" class="scr off">
  <div class="login-icon">ğŸ“±</div>
  <div class="login-h">ĞÑƒĞ¶Ğ½Ğ° Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² Max</div>
  <div class="login-sub">ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Max Ğ½Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğµ<br>Ğ¸ Ğ¾Ñ‚ÑĞºĞ°Ğ½Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ QR-ĞºĞ¾Ğ´ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ</div>
  <img id="qr-img" class="qr-img" style="display:none">
  <button class="btn" style="max-width:280px" onclick="checkLoginDone()">âœ… Ğ¯ Ğ²Ğ¾ÑˆÑ‘Ğ»</button>
  <button class="btn" style="max-width:280px;background:var(--surf2);box-shadow:none;color:var(--text);margin-top:8px" onclick="getScreenshot()">ğŸ“¸ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€</button>
</div>

<!-- â•â• CHAT LIST â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="scr-chats" class="scr off">
  <div class="topbar">
    <div>
      <div class="topbar-title"><b>Max</b></div>
      <div class="topbar-user" id="acc-label"></div>
    </div>
    <div class="ico-btn" onclick="loadChats()">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3">
        <path d="M4 4v5h5M20 20v-5h-5"/>
        <path d="M4 9a8 8 0 0 1 14.54-3M20 15a8 8 0 0 1-14.54 3"/>
      </svg>
    </div>
  </div>

  <div class="srch-wrap">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
      <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
    </svg>
    <input class="srch" placeholder="ĞŸĞ¾Ğ¸ÑĞº" oninput="filterChats(this.value)">
  </div>

  <div id="list"></div>
</div>

<!-- â•â• CHAT VIEW â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="scr-chat" class="scr off">
  <div class="chat-hdr">
    <button class="back-btn" onclick="goBack()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
    </button>
    <div class="av" id="h-av" style="width:42px;height:42px;font-size:17px"></div>
    <div class="chat-hdr-txt">
      <div class="chat-hdr-name" id="h-name"></div>
      <div class="chat-hdr-sub" id="h-sub">Max Messenger</div>
    </div>
    <div class="ico-btn" onclick="refreshMsgs()">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.3">
        <path d="M4 4v5h5M20 20v-5h-5"/>
        <path d="M4 9a8 8 0 0 1 14.54-3M20 15a8 8 0 0 1-14.54 3"/>
      </svg>
    </div>
  </div>

  <div id="msgs"></div>

  <div id="composer">
    <div id="inp" contenteditable="true" data-ph="Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ..."
         onkeydown="onKey(event)" oninput="autoH()"></div>
    <button id="send-btn" onclick="doSend()">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
    </button>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG & STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const tgApp = window.Telegram?.WebApp;
if (tgApp) { tgApp.ready(); tgApp.expand(); }

// API â€” ÑĞµÑ€Ğ²ĞµÑ€ Ğ½Ğ° Ğ²Ğ°ÑˆĞµĞ¼ ĞŸĞš, Ñ‚ÑƒĞ½Ğ½ĞµĞ»ÑŒ Ñ‡ĞµÑ€ĞµĞ· cloudflared/ngrok
// index.html Ğ»ĞµĞ¶Ğ¸Ñ‚ Ğ½Ğ° GitHub Pages, Ğ° API Ğ¶Ğ¸Ğ²Ñ‘Ñ‚ Ğ½Ğ° Ğ²Ğ°ÑˆĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€Ğµ
// Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ URL Ğ²Ğ°ÑˆĞµĞ³Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ° (cloudflare tunnel URL):
const API_URL = "https://Ğ¡Ğ®Ğ”Ğ_URL_Ğ¡Ğ•Ğ Ğ’Ğ•Ğ Ğ"; // â† Ğ—ĞĞœĞ•ĞĞ˜Ğ¢Ğ¬

const params = new URLSearchParams(location.search);
let KEY  = params.get("key") || localStorage.getItem("max_key") || "";
let CHAT = decodeURIComponent(params.get("chat") || "");

let allChats   = [];
let curChat    = null;
let pollTimer  = null;
let accLabel   = "";

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function init() {
  if (KEY) {
    showLoad("ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ...");
    try {
      const r = await api("/api/auth", "POST", { key: KEY });
      if (r.ok) {
        accLabel = r.label || "";
        localStorage.setItem("max_key", KEY);
        if (r.needs_login) {
          hideLoad();
          showScr("scr-login");
          getScreenshot();
        } else {
          await goChats();
          if (CHAT) openChat(CHAT);
        }
      } else {
        KEY = "";
        localStorage.removeItem("max_key");
        hideLoad();
        showScr("scr-auth");
      }
    } catch(e) {
      hideLoad();
      showScr("scr-auth");
    }
  } else {
    hideLoad();
    showScr("scr-auth");
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUTH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function doAuth() {
  const val = document.getElementById("auth-f").value.trim();
  if (!val) return;

  document.getElementById("auth-btn").disabled = true;
  document.getElementById("auth-err").textContent = "";
  showLoad("ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ»ÑÑ‡...");

  try {
    const r = await api("/api/auth", "POST", { key: val });
    if (r.ok) {
      KEY = val;
      accLabel = r.label || "";
      localStorage.setItem("max_key", KEY);
      if (r.needs_login) {
        hideLoad();
        showScr("scr-login");
        getScreenshot();
      } else {
        await goChats();
      }
    } else {
      hideLoad();
      document.getElementById("auth-err").textContent = "âŒ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ĞºĞ»ÑÑ‡";
    }
  } catch(e) {
    hideLoad();
    document.getElementById("auth-err").textContent = "âŒ Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½";
  } finally {
    document.getElementById("auth-btn").disabled = false;
  }
}
document.getElementById("auth-f").onkeydown = e => { if (e.key === "Enter") doAuth(); };

async function checkLoginDone() {
  showLoad("ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼...");
  try {
    const r = await api("/api/auth", "POST", { key: KEY });
    if (r.ok && !r.needs_login) {
      await goChats();
    } else {
      hideLoad();
      toast("âš ï¸ Ğ•Ñ‰Ñ‘ Ğ½Ğµ Ğ²Ğ¾ÑˆĞ»Ğ¸ Ğ² Max â€” Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°");
    }
  } catch(e) { hideLoad(); toast("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°"); }
}

async function getScreenshot() {
  try {
    const r = await api("/api/screenshot");
    if (r.ok) {
      const img = document.getElementById("qr-img");
      img.src = r.image;
      img.style.display = "block";
    }
  } catch(e) {}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function goChats() {
  showLoad("Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ñ‡Ğ°Ñ‚Ñ‹...");
  showScr("scr-chats");
  document.getElementById("acc-label").textContent = accLabel;
  await loadChats();
  hideLoad();
}

async function loadChats() {
  try {
    const r = await api("/api/chats");
    allChats = r.chats || [];
    renderChats(allChats);
  } catch(e) { toast("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸"); }
}

function filterChats(q) {
  renderChats(q ? allChats.filter(c => c.name.toLowerCase().includes(q.toLowerCase())) : allChats);
}

function renderChats(list) {
  const el = document.getElementById("list");
  if (!list.length) {
    el.innerHTML = `<div style="padding:48px;text-align:center;color:var(--muted);font-size:14px">ĞĞµÑ‚ Ñ‡Ğ°Ñ‚Ğ¾Ğ²</div>`;
    return;
  }
  el.innerHTML = list.map(c => `
    <div class="ci ${curChat===c.name?'act':''}" onclick="openChat('${esc(c.name)}')">
      <div class="av" style="${avBg(c.name)}">
        ${c.avatar ? `<img src="${esc(c.avatar)}" loading="lazy" onerror="this.remove()">` : avL(c.name)}
      </div>
      <div class="ci-body">
        <div class="ci-name">${esc(c.name)}</div>
        <div class="ci-prev">${esc(c.preview || 'â€”')}</div>
      </div>
      <div class="ci-meta">
        <div class="ci-time">${esc(c.time || '')}</div>
      </div>
    </div>`
  ).join("");
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OPEN CHAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function openChat(name) {
  curChat = name;
  stopPoll();
  renderChats(allChats);

  // Ğ¨Ğ°Ğ¿ĞºĞ°
  const hav = document.getElementById("h-av");
  hav.style.cssText = avBg(name);
  hav.textContent   = avL(name);
  document.getElementById("h-name").textContent = name;
  document.getElementById("h-sub").textContent  = accLabel;

  showScr("scr-chat");
  showLoad("ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°Ñ Ñ‡Ğ°Ñ‚...");

  try {
    const r = await api("/api/open", "POST", { key: KEY, name });
    hideLoad();
    if (r.ok) {
      renderMsgs(r.messages || []);
      startPoll();
    } else {
      toast("âŒ Ğ§Ğ°Ñ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½");
    }
  } catch(e) {
    hideLoad();
    toast("âŒ ĞÑˆĞ¸Ğ±ĞºĞ°");
  }
}

function goBack() {
  stopPoll();
  curChat = null;
  showScr("scr-chats", true);  // slide back
  renderChats(allChats);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MESSAGES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function refreshMsgs() {
  try {
    const r = await api("/api/messages");
    if (r.ok) renderMsgs(r.messages || []);
  } catch(e) { toast("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ°"); }
}

function renderMsgs(msgs) {
  const el = document.getElementById("msgs");
  if (!msgs.length) {
    el.innerHTML = `<div class="msgs-empty"><span style="font-size:38px">ğŸ’¬</span>ĞĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹</div>`;
    return;
  }
  el.innerHTML = `<div class="day-div">Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ</div>` +
    msgs.map(m =>
      `<div class="bbl ${m.out ? 'b-out' : 'b-in'}">${esc(m.text)}</div>`
    ).join("");
  el.scrollTop = el.scrollHeight;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SEND
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function doSend() {
  const inp  = document.getElementById("inp");
  const text = inp.innerText.trim();
  if (!text || !curChat) return;

  inp.innerText = "";
  autoH();
  document.getElementById("send-btn").disabled = true;

  // ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿ÑƒĞ·Ñ‹Ñ€ÑŒ
  const wrap = document.getElementById("msgs");
  const tmp  = document.createElement("div");
  tmp.className   = "bbl b-out";
  tmp.textContent = text;
  wrap.appendChild(tmp);
  wrap.scrollTop = wrap.scrollHeight;

  try {
    const r = await api("/api/send", "POST", { key: KEY, text });
    if (r.ok) {
      renderMsgs(r.messages || []);
    } else {
      tmp.style.opacity = ".4";
      toast("âŒ ĞĞµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾: " + (r.error || ""));
    }
  } catch(e) {
    tmp.style.opacity = ".4";
    toast("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸");
  } finally {
    document.getElementById("send-btn").disabled = false;
  }
}

function onKey(e) {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); doSend(); }
}
function autoH() {
  const el = document.getElementById("inp");
  el.style.height = "auto";
  el.style.height = Math.min(el.scrollHeight, 134) + "px";
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POLL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startPoll() {
  stopPoll();
  pollTimer = setInterval(async () => {
    if (!curChat) return;
    try {
      const r = await api("/api/messages");
      if (r.ok) renderMsgs(r.messages || []);
    } catch(e) {}
  }, 7000);
}
function stopPoll() { clearInterval(pollTimer); pollTimer = null; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   API HELPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function api(path, method = "GET", body = null) {
  const opts = {
    method,
    headers: { "Content-Type": "application/json", "X-Key": KEY }
  };
  if (body) opts.body = JSON.stringify(body);
  const r = await fetch(API_URL + path, opts);
  if (!r.ok) {
    const err = await r.json().catch(() => ({}));
    throw new Error(err.error || r.status);
  }
  return r.json();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN TRANSITIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showScr(id, slideBack = false) {
  document.querySelectorAll(".scr").forEach(s => {
    s.classList.add("off");
    s.classList.remove("slide-left");
  });
  const el = document.getElementById(id);
  if (slideBack) el.classList.add("slide-left");
  requestAnimationFrame(() => el.classList.remove("off", "slide-left"));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showLoad(t = "Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...") {
  document.getElementById("loader-txt").textContent = t;
  document.getElementById("loader").classList.remove("off");
}
function hideLoad() { document.getElementById("loader").classList.add("off"); }

let _tt;
function toast(msg) {
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.classList.add("on");
  clearTimeout(_tt);
  _tt = setTimeout(() => el.classList.remove("on"), 2800);
}

function esc(s) {
  return String(s || "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}
function avL(n) { return (n || "?")[0].toUpperCase(); }
const PAL = [
  "135deg,#2d4fd6,#5b21b6","135deg,#b91c1c,#d97706",
  "135deg,#047857,#0369a1","135deg,#9d174d,#ea580c",
  "135deg,#6d28d9,#1d4ed8","135deg,#0c4a6e,#14532d",
  "135deg,#7e22ce,#be123c","135deg,#92400e,#134e4a",
];
function avBg(n) {
  const i = [...(n||"")].reduce((a,c) => a + c.charCodeAt(0), 0) % PAL.length;
  return `background:linear-gradient(${PAL[i]})`;
}

/* â”€â”€ START â”€â”€ */
init();
</script>
</body>
</html>
